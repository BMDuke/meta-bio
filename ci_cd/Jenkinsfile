node {

    checkout scm

    stage('Build') {

        sh 'echo "Building image"'
        def metadata_api_image = docker.build("metadata_api", "./api")

    }

    stage('Test') {

        sh 'echo "Testing image"'
        def metadata_api_image = docker.build("metadata_api", "./api")
        metadata_api_image.inside {

            bash 'pytest'

        }

    }    

    stage('Deploy') {

        sh 'echo "Deploying image"'
        metadata_api_image

    }        

}
